<!DOCTYPE html>
<html>
<head>
  <title>Analyse Vidéo - Vitesse main droite</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #fff;
      text-align: center;
      padding: 1rem;
    }
    canvas, video {
      max-width: 90vw;
    }
    #chartContainer {
      width: 90vw;
      height: 300px;
      margin: 2rem auto;
    }
  </style>
</head>
<body>
  <h1>Vitesse linéaire de la main droite (en m/s)</h1>
  <input type="file" accept="video/*" id="uploadInput" />
  <br><br>
  <video id="inputVideo" controls></video>
  <canvas id="outputCanvas"></canvas>

  <div id="chartContainer">
    <canvas id="velocityChart"></canvas>
  </div>

  <script>
    const video = document.getElementById('inputVideo');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const uploadInput = document.getElementById('uploadInput');

    let lastRightWrist = null;
    let lastTimestamp = null;
    let velocityBuffer = [];
    const maxBufferLength = 5;

    const timeSeries = [];
    const velocitySeries = [];

    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(onResults);

    function onResults(results) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (results.poseLandmarks) {
        drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 3 });
        drawLandmarks(ctx, results.poseLandmarks, { color: '#FF0000', lineWidth: 2 });

        const wrist = results.poseLandmarks[16]; // Poignet droit
        const timestamp = performance.now();

        if (lastRightWrist && lastTimestamp) {
          const dx = (wrist.x - lastRightWrist.x);
          const dy = (wrist.y - lastRightWrist.y);
          const dz = (wrist.z - lastRightWrist.z);
          const dt = (timestamp - lastTimestamp) / 1000; // en secondes

          const dist_px = Math.sqrt(dx * dx + dy * dy + dz * dz);
          const distance_m = dist_px * 1.8; // facteur d'échelle estimé
          const velocity = distance_m / dt;

          // Ajout au buffer de filtrage
          velocityBuffer.push(velocity);
          if (velocityBuffer.length > maxBufferLength) velocityBuffer.shift();
          const avgVelocity = velocityBuffer.reduce((a, b) => a + b, 0) / velocityBuffer.length;

          // Limite supérieure : 50 m/s (pour ignorer les spikes)
          const cappedVelocity = Math.min(avgVelocity, 50);

          const time = (video.currentTime).toFixed(2);
          timeSeries.push(time);
          velocitySeries.push(cappedVelocity);
          velocityChart.data.labels = timeSeries;
          velocityChart.data.datasets[0].data = velocitySeries;
          velocityChart.update();
        }

        lastRightWrist = wrist;
        lastTimestamp = timestamp;
      }
    }

    uploadInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
        video.load();
      }
    });

    video.addEventListener('play', () => {
      const processFrame = async () => {
        if (!video.paused && !video.ended) {
          await pose.send({ image: video });
          requestAnimationFrame(processFrame);
        }
      };
      requestAnimationFrame(processFrame);
    });

    // Chart.js configuration
    const ctxChart = document.getElementById('velocityChart').getContext('2d');
    const velocityChart = new Chart(ctxChart, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Vitesse (m/s)',
          data: [],
          borderColor: 'orange',
          borderWidth: 2,
          fill: false,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Temps (s)'
            }
          },
          y: {
            min: 0,
            max: 60,
            title: {
              display: true,
              text: 'Vitesse (m/s)'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
