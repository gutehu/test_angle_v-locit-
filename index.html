
<!DOCTYPE html>
<html>
<head>
  <title>Push Press Counter & Vélocité Globale</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
    }
    #poseCanvas {
      width: 95vw;
      margin-top: 10px;
    }
    select {
      margin-top: 10px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }
    #status {
      font-size: 1.6rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Détection Push Press (x10)</h2>
  <label for="cameraDeviceSelect">Choisir la caméra :</label>
  <select id="cameraDeviceSelect"></select>
  <div id="status">Répétitions : <span id="reps">0</span> / 10</div>
  <div id="finalVelocity" style="font-size:1.4rem; margin-top: 10px;"></div>
  <video class="input_video" style="display:none;" autoplay playsinline></video>
  <canvas id="poseCanvas" width="640" height="480"></canvas>

  <script>
    const videoElement = document.querySelector('.input_video');
    const canvas = document.getElementById('poseCanvas');
    const ctx = canvas.getContext('2d');
    const cameraDeviceSelect = document.getElementById('cameraDeviceSelect');
    const repsEl = document.getElementById('reps');
    const finalVelocityEl = document.getElementById('finalVelocity');
    let camera = null;
    let currentStream = null;

    let reps = 0;
    let wasAbove = false;
    let totalVelocity = 0;
    let velocitySamples = 0;
    let isActive = true;

    let previous = { time: null, wristY: null };

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      cameraDeviceSelect.innerHTML = '';
      videoDevices.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Caméra ${index + 1}`;
        cameraDeviceSelect.appendChild(option);
      });
    }

    async function startPoseDetection(deviceId) {
      if (camera) {
        camera.stop();
        camera = null;
      }
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: deviceId } }
      });
      videoElement.srcObject = stream;
      currentStream = stream;

      const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      pose.onResults(results => {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (!isActive) return;

        const lm = results.poseLandmarks;
        if (lm) {
          const rShoulder = lm[12], rWrist = lm[16];
          if (rShoulder && rWrist) {
            const wristY = rWrist.y;
            const shoulderY = rShoulder.y;

            const now = performance.now();
            const current = {
              time: now,
              wristY: rWrist.y * canvas.height
            };

            // Vélocité verticale
            if (previous.time !== null && previous.wristY !== null) {
              const dt = (current.time - previous.time) / 1000;
              const dy = previous.wristY - current.wristY; // mouvement vers le haut
              const velocity = dy / dt;

              // Mouvement vers le haut + franchissement seuil épaule
              if (!wasAbove && rWrist.y < rShoulder.y && velocity > 300) {
                reps++;
                repsEl.textContent = reps;
                wasAbove = true;
                totalVelocity += velocity;
                velocitySamples++;

                if (reps >= 10) {
                  isActive = false;
                  const avgVelocity = totalVelocity / velocitySamples;
                  finalVelocityEl.innerHTML = "✅ Vélocité moyenne globale : <b>" + avgVelocity.toFixed(1) + " px/s</b>";
                }
              }

              if (rWrist.y >= rShoulder.y) {
                wasAbove = false;
              }
            }

            previous = current;
          }
        }

        ctx.restore();
      });

      camera = new Camera(videoElement, {
        onFrame: async () => await pose.send({ image: videoElement }),
        width: 640,
        height: 480
      });

      camera.start();
    }

    cameraDeviceSelect.addEventListener('change', () => {
      startPoseDetection(cameraDeviceSelect.value);
    });

    async function init() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
      } catch (e) {
        alert("Accès caméra refusé.");
        return;
      }

      await listCameras();
      if (cameraDeviceSelect.options.length > 0) {
        startPoseDetection(cameraDeviceSelect.value);
      }
    }

    init();
  </script>
</body>
</html>
