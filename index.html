
<!DOCTYPE html>
<html>
<head>
  <title>Vélocité et Vitesse Angulaire - Courbe Live</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
    }
    #poseCanvas {
      width: 95vw;
      margin-top: 10px;
    }
    #chartContainer {
      width: 95vw;
      margin: auto;
      margin-top: 20px;
    }
    select {
      margin-top: 10px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }
  </style>
</head>
<body>
  <h2>Suivi en direct : Vélocité & Vitesse angulaire</h2>
  <label for="cameraDeviceSelect">Choisir la caméra :</label>
  <select id="cameraDeviceSelect"></select><br>
  <video class="input_video" style="display:none;" autoplay playsinline></video>
  <canvas id="poseCanvas" width="640" height="480"></canvas>
  <div id="chartContainer">
    <canvas id="velocityChart" height="200"></canvas>
  </div>

  <script>
    const videoElement = document.querySelector('.input_video');
    const canvas = document.getElementById('poseCanvas');
    const ctx = canvas.getContext('2d');
    const cameraDeviceSelect = document.getElementById('cameraDeviceSelect');
    let camera = null;
    let currentStream = null;

    let previous = { time: null, wrist: null, angle: null };

    const velocityChartCtx = document.getElementById('velocityChart').getContext('2d');
    const maxDataPoints = 50;
    const velocityData = [];
    const angularVelocityData = [];

    const chart = new Chart(velocityChartCtx, {
      type: 'line',
      data: {
        labels: Array(maxDataPoints).fill(""),
        datasets: [
          {
            label: 'Vélocité (px/s)',
            data: velocityData,
            borderColor: 'cyan',
            fill: false,
            tension: 0.2
          },
          {
            label: 'Vitesse angulaire (°/s)',
            data: angularVelocityData,
            borderColor: 'orange',
            fill: false,
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    function updateChart(velocity, angularVelocity) {
      if (velocityData.length >= maxDataPoints) {
        velocityData.shift();
        angularVelocityData.shift();
        chart.data.labels.shift();
      }

      velocityData.push(velocity);
      angularVelocityData.push(angularVelocity);
      chart.data.labels.push('');
      chart.update();
    }

    function calculateAngle(a, b, c) {
      const ab = { x: b.x - a.x, y: b.y - a.y };
      const cb = { x: b.x - c.x, y: b.y - c.y };
      const dot = ab.x * cb.x + ab.y * cb.y;
      const abMag = Math.sqrt(ab.x**2 + ab.y**2);
      const cbMag = Math.sqrt(cb.x**2 + cb.y**2);
      const angle = Math.acos(dot / (abMag * cbMag));
      return angle * 180 / Math.PI;
    }

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      cameraDeviceSelect.innerHTML = '';
      videoDevices.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Caméra ${index + 1}`;
        cameraDeviceSelect.appendChild(option);
      });
    }

    async function startPoseDetection(deviceId) {
      if (camera) {
        camera.stop();
        camera = null;
      }
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: deviceId } }
      });
      videoElement.srcObject = stream;
      currentStream = stream;

      const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      pose.onResults(results => {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        const lm = results.poseLandmarks;
        if (lm) {
          const rShoulder = lm[12], rElbow = lm[14], rWrist = lm[16];

          if (rShoulder && rElbow && rWrist) {
            const now = performance.now();
            const current = {
              time: now,
              wrist: { x: rWrist.x * canvas.width, y: rWrist.y * canvas.height },
              angle: calculateAngle(rShoulder, rElbow, rWrist)
            };

            if (previous.time !== null && previous.wrist) {
              const dt = (current.time - previous.time) / 1000;
              const dx = current.wrist.x - previous.wrist.x;
              const dy = current.wrist.y - previous.wrist.y;
              const distance = Math.sqrt(dx*dx + dy*dy);
              const velocity = distance / dt;

              const dAngle = current.angle - previous.angle;
              const angularVelocity = Math.abs(dAngle / dt);

              updateChart(velocity, angularVelocity);
            }

            previous = current;
          }
        }

        ctx.restore();
      });

      camera = new Camera(videoElement, {
        onFrame: async () => await pose.send({ image: videoElement }),
        width: 640,
        height: 480
      });

      camera.start();
    }

    cameraDeviceSelect.addEventListener('change', () => {
      startPoseDetection(cameraDeviceSelect.value);
    });

    async function init() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
      } catch (e) {
        alert("Accès caméra refusé. Autorisez la caméra.");
        return;
      }

      await listCameras();
      if (cameraDeviceSelect.options.length > 0) {
        startPoseDetection(cameraDeviceSelect.value);
      }
    }

    init();
  </script>
</body>
</html>
